name: "Data Scribe Unit Tests"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      ollama:
        image: ollama/ollama
        ports:
          - 11434:11434

    steps:
    - name: "Checkout Code"
      uses: actions/checkout@v4

    - name: "Set up Python 3.11"
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: "Install Dependencies"
      run: |
        pip install -e .
        pip install pytest
        pip install dbt-core

    - name: "Install Ollama CLI on Host Runner"
      run: |
        curl -fsSL https://ollama.com/install.sh | sh

    - name: "Setup Ollama (Pull Model)"
      run: |
        export OLLAMA_HOST="http://localhost:11434"
        
        n=0
        until [ "$n" -ge 30 ]; do
          if curl -s http://localhost:11434/ > /dev/null; then
            echo "Ollama service is up!"
            break
          fi
          n=$((n+1))
          sleep 1
        done

        echo "Pulling llama3 model..."
        ollama pull llama3
        echo "Model pulled successfully."

    - name: "Checkout jaffle_shop (for dbt test)"
      uses: actions/checkout@v4
      with:
        repository: 'dbt-labs/jaffle_shop'
        path: 'jaffle_shop'

    - name: "Run Pytest"
      run: |
        pytest data_scribe/tests/
      env: 
        OLLAMA_HOST: "http://localhost:11434"